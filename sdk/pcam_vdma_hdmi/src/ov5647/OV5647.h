/*
 * OV5647.h
 *
 *  Created on: May 26, 2016
 *      Author: Elod
 *
 * Modification history: Jan 7, 2019
 *      Modified by: Szilard Hegedus
 *         - Removed all OV5640 configuration, added initialization config for OV5647
 *         - Replaced I2C driver
 */

#ifndef OV5647_H_
#define OV5647_H_

#include <sstream>
#include <iostream>
#include <cstdio>
#include <climits>

#include "../hdmi/VideoOutput.h"
#include "../ov5647/GPIO_Client.h"
#include "../ov5647/i2c.h"

#define SIZEOF_ARRAY(x) sizeof(x)/sizeof(x[0])
#define MAP_ENUM_TO_CFG(en, cfg) en, cfg, SIZEOF_ARRAY(cfg)

#define I2C_ADDR  (0x6c >> 1)
#define DEV_ID_H 0x56
#define DEV_ID_L 0x47
#define REG_ID_H 0x300A
#define REG_ID_L 0x300B

#define SENSOR_NAME "ov5647"

namespace digilent {

typedef enum {OK=0, ERR_LOGICAL, ERR_GENERAL} Errc;

namespace OV5647_cfg {
	using config_word_t = struct { uint16_t addr; uint8_t data; } ;
	using mode_t = enum {MODE_1920x1080, MODE_1280x720, MODE_640x480, MODE_END } ;
	using config_modes_t = struct { mode_t mode; config_word_t const* cfg; size_t cfg_size; };
	using test_t = enum { TEST_DISABLED = 0, TEST_EIGHT_COLOR_BAR, TEST_END };
	uint16_t const OV5647_REG_PRE_ISP_TEST_SET1 = 0x503D;
	uint16_t const OV5647_FORMAT_MUX_CONTROL = 0x501f;

	// 1920 x 1080
	config_word_t const cfg_1080p[] =
	{
			{0x0103,0x01},
			{0x0100,0x00},
			{0x0100,0x00},
			{0x0103,0x01},
			{0x3034,0x1A},
			{0x3035,0x21},
			{0x3036,0x62},
			{0x303C,0x11},
			{0x3106,0xF5},
			{0x3821,0x01},
			{0x3820,0x46},
			{0x3827,0xEC},
			{0x370C,0x03},
			{0x3612,0x5B},
			{0x3618,0x04},
			{0x5000,0x06},
			{0x5002,0x40},
			{0x5003,0x08},
			{0x5A00,0x08},
			{0x3000,0x00},
			{0x3001,0x00},
			{0x3002,0x00},
			{0x3016,0x08},
			{0x3017,0xE0},
			{0x3018,0x44},
			{0x301C,0xF8},
			{0x301D,0xF0},
			{0x3A18,0x00},
			{0x3A19,0xF8},
			{0x3C01,0x80},
			{0x3B07,0x0C},
			{0x380C,0x09},
			{0x380D,0x70},
			{0x380E,0x04},
			{0x380F,0x50},
			{0x3814,0x11},
			{0x3815,0x11},
			{0x3708,0x64},
			{0x3709,0x12},
			{0x3808,0x07},
			{0x3809,0x80},
			{0x380A,0x04},
			{0x380B,0x38},
			{0x3800,0x01},
			{0x3801,0x5C},
			{0x3802,0x01},
			{0x3803,0xB2},
			{0x3804,0x08},
			{0x3805,0xE3},
			{0x3806,0x05},
			{0x3807,0xF1},
			{0x3811,0x04},
			{0x3813,0x02},
			{0x3630,0x2E},
			{0x3632,0xE2},
			{0x3633,0x23},
			{0x3634,0x44},
			{0x3636,0x06},
			{0x3620,0x64},
			{0x3621,0xE0},
			{0x3600,0x37},
			{0x3704,0xA0},
			{0x3703,0x5A},
			{0x3715,0x78},
			{0x3717,0x01},
			{0x3731,0x02},
			{0x370B,0x60},
			{0x3705,0x1A},
			{0x3F05,0x02},
			{0x3F06,0x10},
			{0x3F01,0x0A},
			{0x3A08,0x01},
			{0x3A09,0x4B},
			{0x3A0A,0x01},
			{0x3A0B,0x13},
			{0x3A0D,0x04},
			{0x3A0E,0x03},
			{0x3A0F,0x58},
			{0x3A10,0x50},
			{0x3A1B,0x58},
			{0x3A1E,0x50},
			{0x3A11,0x60},
			{0x3A1F,0x28},
			{0x4001,0x02},
			{0x4004,0x04},
			{0x4000,0x09},
			{0x4837,0x19},
			{0x4800,0x34},
			{0x3503,0x03},
			{0x3821,0x01},
			{0x350A,0x00},
			{0x350B,0x10},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x15},
			{0x3502,0x20},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x10},
			{0x350A,0x00},
			{0x350B,0x10},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x15},
			{0x3502,0x20},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x0100,0x01},
			{0x350A,0x00},
			{0x350B,0x10},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x15},
			{0x3502,0x20},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x13},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x45},
			{0x3502,0xB0},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x13},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x45},
			{0x3502,0xB0},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x17},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x45},
			{0x3502,0xB0},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x18},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x4F},
			{0x3502,0x20},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x19},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x54},
			{0x3502,0x80},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x1B},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x54},
			{0x3502,0x80},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x1D},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x54},
			{0x3502,0x80},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x1A},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x54},
			{0x3502,0x80},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x18},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x51},
			{0x3502,0x40},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x18},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x4A},
			{0x3502,0xF0},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x18},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x47},
			{0x3502,0x40},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x18},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x49},
			{0x3502,0x20},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x18},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x4B},
			{0x3502,0xE0},
			{0x3212,0x10},
			{0x3212,0xA0},
			{0x350A,0x00},
			{0x350B,0x18},
			{0x3212,0x00},
			{0x3500,0x00},
			{0x3501,0x4E},
			{0x3502,0x30},
			{0x3212,0x10},
			{0x3212,0xA0}


	};

	config_word_t const cfg_720p[] =
		{
				{0x0103,0x01},
				{0x0100,0x00},
				{0x0100,0x00},
				{0x0103,0x01},
				{0x3034,0x1A},
				{0x3035,0x21},
				{0x3036,0x62},
				{0x303C,0x11},
				{0x3106,0xF5},
				{0x3821,0x01},
				{0x3820,0x46},
				{0x3827,0xEC},
				{0x370C,0x03},
				{0x3612,0x59},
				{0x3618,0x00},
				{0x5000,0x06},
				{0x5002,0x40},
				{0x5003,0x08},
				{0x5A00,0x08},
				{0x3000,0x00},
				{0x3001,0x00},
				{0x3002,0x00},
				{0x3016,0x08},
				{0x3017,0xE0},
				{0x3018,0x44},
				{0x301C,0xF8},
				{0x301D,0xF0},
				{0x3A18,0x00},
				{0x3A19,0xF8},
				{0x3C01,0x80},
				{0x3B07,0x0C},
				{0x3800,0x00},
				{0x3801,0x00},
				{0x3802,0x00},
				{0x3803,0x00},
				{0x3804,0x0A},
				{0x3805,0x3F},
				{0x3806,0x07},
				{0x3807,0xA3},
				{0x3808,0x05},
				{0x3809,0x10},
				{0x380A,0x03},
				{0x380B,0xCC},
				{0x380C,0x07},
				{0x380D,0x68},
				{0x380E,0x04},
				{0x380F,0x50},
				{0x3811,0x10},
				{0x3813,0x06},
				{0x3814,0x31},
				{0x3815,0x31},
				{0x3630,0x2E},
				{0x3632,0xE2},
				{0x3633,0x23},
				{0x3634,0x44},
				{0x3636,0x06},
				{0x3620,0x64},
				{0x3621,0xE0},
				{0x3600,0x37},
				{0x3704,0xA0},
				{0x3703,0x5A},
				{0x3715,0x78},
				{0x3717,0x01},
				{0x3731,0x02},
				{0x370B,0x60},
				{0x3705,0x1A},
				{0x3F05,0x02},
				{0x3F06,0x10},
				{0x3F01,0x0A},
				{0x3A08,0x01},
				{0x3A09,0x28},
				{0x3A0A,0x00},
				{0x3A0B,0xF6},
				{0x3A0D,0x08},
				{0x3A0E,0x06},
				{0x3A0F,0x58},
				{0x3A10,0x50},
				{0x3A1B,0x58},
				{0x3A1E,0x50},
				{0x3A11,0x60},
				{0x3A1F,0x28},
				{0x4001,0x02},
				{0x4004,0x04},
				{0x4000,0x09},
				{0x4837,0x16},
				{0x4800,0x24},
				{0x3503,0x03},
				{0x3820,0x46},
				{0x3821,0x01},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x1A},
				{0x3502,0xF0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x1A},
				{0x3502,0xF0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x0100,0x01},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x1A},
				{0x3502,0xF0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x13},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x58},
				{0x3502,0xD0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x13},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x58},
				{0x3502,0xD0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x15},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x58},
				{0x3502,0xD0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x16},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x58},
				{0x3502,0xD0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x17},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x58},
				{0x3502,0xD0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x18},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x63},
				{0x3502,0xE0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x18},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x5D},
				{0x3502,0xD0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x13},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x58},
				{0x3502,0xD0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x58},
				{0x3502,0xD0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x55},
				{0x3502,0x80},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x51},
				{0x3502,0x70},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x4F},
				{0x3502,0x90},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x4E},
				{0x3502,0x10},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x4B},
				{0x3502,0xE0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x4A},
				{0x3502,0x10},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x48},
				{0x3502,0x90},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x47},
				{0x3502,0x70},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x46},
				{0x3502,0x70},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x47},
				{0x3502,0xB0},
				{0x3212,0x10},
				{0x3212,0xA0},
				{0x350A,0x00},
				{0x350B,0x10},
				{0x3212,0x00},
				{0x3500,0x00},
				{0x3501,0x49},
				{0x3502,0xA0},
				{0x3212,0x10},
				{0x3212,0xA0}

		};

	config_word_t const cfg_VGA[] =
			{
					{0x0103,0x01},
					{0x0100,0x00},
					{0x0103,0x01},
					{0x3035,0x11},
					{0x3036,0x46},
					{0x303C,0x11},
					{0x3821,0x01},
					{0x3820,0x46},
					{0x370C,0x03},
					{0x3612,0x59},
					{0x3618,0x00},
					{0x5000,0x06},
					{0x5003,0x08},
					{0x5A00,0x08},
					{0x3000,0xFF},
					{0x3001,0xFF},
					{0x3002,0xFF},
					{0x301D,0xF0},
					{0x3A18,0x00},
					{0x3A19,0xF8},
					{0x3C01,0x80},
					{0x3B07,0x0C},
					{0x380C,0x07},
					{0x380D,0x3C},
					{0x380E,0x01},
					{0x380F,0xF8},
					{0x3814,0x71},
					{0x3815,0x71},
					{0x3708,0x64},
					{0x3709,0x52},
					{0x3808,0x02},
					{0x3809,0x80},
					{0x380A,0x01},
					{0x380B,0xE0},
					{0x3800,0x00},
					{0x3801,0x10},
					{0x3802,0x00},
					{0x3803,0x00},
					{0x3804,0x0A},
					{0x3805,0x2F},
					{0x3806,0x07},
					{0x3807,0x9F},
					{0x3630,0x2E},
					{0x3632,0xE2},
					{0x3633,0x23},
					{0x3634,0x44},
					{0x3620,0x64},
					{0x3621,0xE0},
					{0x3600,0x37},
					{0x3704,0xA0},
					{0x3703,0x5A},
					{0x3715,0x78},
					{0x3717,0x01},
					{0x3731,0x02},
					{0x370B,0x60},
					{0x3705,0x1A},
					{0x3F05,0x02},
					{0x3F06,0x10},
					{0x3F01,0x0A},
					{0x3A08,0x01},
					{0x3A09,0x2E},
					{0x3A0A,0x00},
					{0x3A0B,0xFB},
					{0x3A0D,0x02},
					{0x3A0E,0x01},
					{0x3A0F,0x58},
					{0x3A10,0x50},
					{0x3A1B,0x58},
					{0x3A1E,0x50},
					{0x3A11,0x60},
					{0x3A1F,0x28},
					{0x4001,0x02},
					{0x4004,0x02},
					{0x4000,0x09},
					{0x3000,0x00},
					{0x3001,0x00},
					{0x3002,0x00},
					{0x3017,0xE0},
					{0x301C,0xFC},
					{0x3636,0x06},
					{0x3016,0x08},
					{0x3827,0xEC},
					{0x3018,0x44},
					{0x3035,0x21},
					{0x3106,0xF5},
					{0x3034,0x1A},
					{0x301C,0xF8},
					{0x4800,0x34},
					{0x3503,0x03},
					{0x3821,0x01},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x13},
					{0x3502,0xB0},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x13},
					{0x3502,0xB0},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x0100,0x01},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x13},
					{0x3502,0xB0},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x1A},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x1B},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x1A},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x1B},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x21},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x2A},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x2A},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x24},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x20},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x1C},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x1A},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x16},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x13},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x12},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x40},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2C},
					{0x3502,0x70},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2A},
					{0x3502,0xD0},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x29},
					{0x3502,0x90},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x29},
					{0x3502,0x00},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2A},
					{0x3502,0x10},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2B},
					{0x3502,0x20},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2C},
					{0x3502,0xE0},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x12},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x13},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x13},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x13},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x12},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x11},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2E},
					{0x3502,0x60},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x2D},
					{0x3502,0xC0},
					{0x3212,0x10},
					{0x3212,0xA0},
					{0x350A,0x00},
					{0x350B,0x10},
					{0x3212,0x00},
					{0x3500,0x00},
					{0x3501,0x28},
					{0x3502,0xB0},
					{0x3212,0x10},
					{0x3212,0xA0}

			};

	config_modes_t const modes[] =
	{
			{ MAP_ENUM_TO_CFG(MODE_1920x1080, cfg_1080p) },
			{ MAP_ENUM_TO_CFG(MODE_1280x720, cfg_720p) },
			{ MAP_ENUM_TO_CFG(MODE_640x480, cfg_VGA) }
	};
}

class OV5647 {
public:
	class HardwareError;

	OV5647(GPIO_Client& gpio) :
		gpio_(gpio)
	{
		InitializeIICdriver();
		reset();
		init();
	}
	void set_sw_standby(bool standby);
	void ov5647_set_virtual_channel(int channel);
	void init();
	Errc reset();
	Errc set_mode(OV5647_cfg::mode_t mode)
	{
		if (mode >= OV5647_cfg::mode_t::MODE_END)
				return ERR_LOGICAL;

			auto cfg_mode = &OV5647_cfg::modes[mode];
			writeConfig(cfg_mode->cfg, cfg_mode->cfg_size);

			return OK;
	}

	~OV5647() { }
	void set_test(OV5647_cfg::test_t test);
	void readReg(uint16_t reg_addr, uint8_t& buf);
	void writeReg(uint16_t reg_addr, uint8_t const reg_data);
	class HardwareError : public std::runtime_error
	{
	public:
		using Errc = enum {WRONG_ID = 1, IIC_NACK};
		HardwareError(Errc errc, char const* msg) : std::runtime_error(msg), errc_(errc) {}
		Errc errc() const { return errc_; }
	private:
		Errc errc_;
	};
private:
	void usleep(uint32_t time);
	void writeConfig(OV5647_cfg::config_word_t const* cfg, size_t cfg_size)
	{
		for (size_t i=0; i<cfg_size; ++i)
			{
				xil_i2c_write_A16_D8(I2C_ADDR, cfg[i].addr, cfg[i].data);
			}
	}
	GPIO_Client& gpio_;
	unsigned int const retry_count_ = 10;
};

} /* namespace digilent */

#endif /* OV5647_H_ */
